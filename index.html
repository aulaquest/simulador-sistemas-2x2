<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Ecuaciones Lineales 2x2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Plugin para zoom y pan en el gráfico -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMVIUpYHmvsplGIZjQsLMRdQSYNGEQUCmMvKCnmK2BqH0iK38" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            flex-grow: 1;
        }
        .tab-btn {
            transition: all 0.3s ease;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .tab-btn.active {
            border-color: #4f46e5;
            background-color: #4f46e5;
            color: white;
        }
        .solution-step {
            background-color: #f9fafb;
            border-left: 3px solid #6366f1;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.25rem;
        }
        .step-content {
            overflow-x: auto; /* Permite scroll horizontal en ecuaciones largas */
            padding-bottom: 0.5rem; /* Espacio para la barra de scroll */
        }
        .input-field {
            width: 55px;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.25rem;
            font-size: 1rem;
            -moz-appearance: textfield;
        }
        .input-field.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 2px #fecaca;
        }
        .input-field::-webkit-outer-spin-button,
        .input-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .katex-display > .katex {
             white-space: nowrap; /* Evita que KaTeX rompa la línea */
        }
        #chart {
            touch-action: none; 
        }
        /* Notification Modal Styles */
        #notification-modal {
            transition: opacity 0.3s ease;
        }
        .zoom-btn {
            width: 40px;
            height: 40px;
            font-size: 24px;
            line-height: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Notification Modal -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Error de Entrada</h3>
            <div class="mt-2 px-7 py-3">
                <p id="notification-message" class="text-sm text-gray-600">
                    Mensaje de error aquí.
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="notification-close-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                    Entendido
                </button>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-3 md:p-4 max-w-4xl">
        
        <div class="bg-white p-5 rounded-lg shadow-md border border-gray-200 mb-6">
            
            <div class="flex items-center justify-center">
                <div class="text-7xl font-light mr-4 text-gray-400" style="line-height: 1;">{</div>
                <div class="flex flex-col space-y-3">
                    <div class="flex items-center space-x-2 text-lg">
                        <input id="a" type="text" class="input-field" placeholder="a">
                        <span class="font-semibold">x +</span>
                        <input id="b" type="text" class="input-field" placeholder="b">
                        <span class="font-semibold">y =</span>
                        <input id="c" type="text" class="input-field" placeholder="c">
                    </div>
                    <div class="flex items-center space-x-2 text-lg">
                        <input id="d" type="text" class="input-field" placeholder="d">
                        <span class="font-semibold">x +</span>
                        <input id="e" type="text" class="input-field" placeholder="e">
                        <span class="font-semibold">y =</span>
                        <input id="f" type="text" class="input-field" placeholder="f">
                    </div>
                </div>
            </div>
             <div class="text-center text-gray-500 text-xs mt-4">
                <p>Puedes usar enteros (Z), reales (R, ej: `1.5` o `1,5`) y racionales (Q, ej: `3/4`).</p>
            </div>
            <div class="mt-5 flex justify-center space-x-3">
                <button id="solveBtn" class="bg-indigo-600 text-white font-semibold py-2 px-5 text-base rounded-lg hover:bg-indigo-700 transition duration-300 shadow-sm">Resolver</button>
                <button id="randomBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 text-base rounded-lg hover:bg-gray-300 transition duration-300">Aleatorio</button>
                <button id="resetBtn" class="bg-red-500 text-white font-semibold py-2 px-5 text-base rounded-lg hover:bg-red-600 transition duration-300">Reiniciar</button>
            </div>
        </div>

        <div class="mb-5">
            <div class="flex flex-wrap justify-center border-b border-gray-300">
                <button class="tab-btn active font-medium border-b-2 border-transparent rounded-t-md" data-tab="sustitucion">Sustitución</button>
                <button class="tab-btn font-medium border-b-2 border-transparent rounded-t-md" data-tab="igualacion">Igualación</button>
                <button class="tab-btn font-medium border-b-2 border-transparent rounded-t-md" data-tab="reduccion">Reducción</button>
                <button class="tab-btn font-medium border-b-2 border-transparent rounded-t-md" data-tab="grafico">Gráfico</button>
            </div>
        </div>

        <div id="contentPanels" class="bg-white p-4 md:p-6 rounded-lg shadow-md border border-gray-200 min-h-[400px]">
            <div id="sustitucion" class="tab-content"></div>
            <div id="igualacion" class="tab-content hidden"></div>
            <div id="reduccion" class="tab-content hidden"></div>
            <div id="grafico" class="tab-content hidden">
                 <div id="graph-container" class="hidden">
                    <div id="graph-info"></div>
                    <div class="text-center my-3">
                        <label for="showSolutionCheckbox" class="cursor-pointer text-base">
                            <input type="checkbox" id="showSolutionCheckbox" class="mr-2 align-middle rounded border-gray-400 text-indigo-600 focus:ring-indigo-500">
                            Mostrar punto de corte
                        </label>
                    </div>
                    <div class="relative" style="height: 65vh; max-height: 500px;">
                        <canvas id="chart"></canvas>
                         <!-- Zoom Buttons -->
                        <div id="zoom-controls" class="absolute bottom-4 right-4 flex flex-col space-y-2">
                            <button id="zoom-in-btn" class="zoom-btn bg-gray-800 text-white rounded-full shadow-lg hover:bg-gray-700 transition">+</button>
                            <button id="zoom-out-btn" class="zoom-btn bg-gray-800 text-white rounded-full shadow-lg hover:bg-gray-700 transition">-</button>
                        </div>
                    </div>
                </div>
                <div id="graph-placeholder" class="text-center text-gray-500 pt-16">
                    <p>Introduce los coeficientes del sistema de ecuaciones y pulsa "Resolver" para generar el gráfico.</p>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="text-center p-4 text-gray-500 text-sm">
        Simulación creada por <a href="https://aulaquest.com" target="_blank" class="text-indigo-600 hover:underline font-semibold">AulaQuest</a>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Register the zoom plugin with Chart.js
            Chart.register(ChartZoom);

            // Get DOM elements
            const solveBtn = document.getElementById('solveBtn');
            const randomBtn = document.getElementById('randomBtn');
            const resetBtn = document.getElementById('resetBtn');
            const tabs = document.querySelectorAll('.tab-btn');
            const contentPanels = document.getElementById('contentPanels');
            const showSolutionCheckbox = document.getElementById('showSolutionCheckbox');
            const graphContainer = document.getElementById('graph-container');
            const graphPlaceholder = document.getElementById('graph-placeholder');
            const notificationModal = document.getElementById('notification-modal');
            const notificationMessage = document.getElementById('notification-message');
            const notificationCloseBtn = document.getElementById('notification-close-btn');
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            const zoomControls = document.getElementById('zoom-controls');

            // State variables
            let chartInstance = null;
            let lastSolutionData = {};

            // --- EVENT LISTENERS ---
            solveBtn.addEventListener('click', solve);
            randomBtn.addEventListener('click', generateRandomEquations);
            resetBtn.addEventListener('click', resetSimulator);
            
            showSolutionCheckbox.addEventListener('change', () => {
                if(getActiveTab() === 'grafico' && lastSolutionData.coeffs) {
                    solveByGrafico(lastSolutionData.coeffs, lastSolutionData.solution, lastSolutionData.caseType);
                }
            });

            notificationCloseBtn.addEventListener('click', () => {
                notificationModal.classList.add('hidden');
            });

            zoomInBtn.addEventListener('click', () => {
                if (chartInstance) {
                    chartInstance.zoom(1.1); // Zoom in by 10%
                    handleZoom(chartInstance);
                }
            });

            zoomOutBtn.addEventListener('click', () => {
                if (chartInstance) {
                    chartInstance.zoom(0.9); // Zoom out by 10%
                    handleZoom(chartInstance);
                }
            });
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(p => p.classList.add('hidden'));
                    
                    tab.classList.add('active');
                    const activeTabContent = document.getElementById(tab.dataset.tab);
                    activeTabContent.classList.remove('hidden');
                    
                    if (Object.keys(lastSolutionData).length > 0) {
                        if (tab.dataset.tab === 'grafico') {
                            solveByGrafico(lastSolutionData.coeffs, lastSolutionData.solution, lastSolutionData.caseType);
                        }
                        renderMathInElement(activeTabContent);
                    }
                });
            });

            contentPanels.addEventListener('change', function(e) {
                if (e.target.classList.contains('show-steps-checkbox')) {
                    const targetId = e.target.dataset.target;
                    const stepsContainer = document.getElementById(targetId);
                    if (stepsContainer) {
                        stepsContainer.classList.toggle('hidden');
                    }
                }
            });
            
            // --- UTILITY FUNCTIONS ---

            function showNotification(message) {
                notificationMessage.textContent = message;
                notificationModal.classList.remove('hidden');
            }

            function renderMathInElement(elem) {
                if (elem && window.renderMathInElement) {
                    window.renderMathInElement(elem, {
                        delimiters: [ {left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false} ],
                        throwOnError: false
                    });
                }
            }
            
            function parseInput(value) {
                if (value === null || value.trim() === '') return null;
                value = value.trim().replace(',', '.');
                
                if (value.includes('/')) {
                    const parts = value.split('/');
                    if (parts.length === 2 && parts[0].trim() !== '' && parts[1].trim() !== '') {
                        const numerator = parseFloat(parts[0]);
                        const denominator = parseFloat(parts[1]);
                        if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
                            return numerator / denominator;
                        }
                    }
                    return null; 
                } else {
                    const num = parseFloat(value);
                    return isNaN(num) ? null : num;
                }
            }

            function getCoefficients() {
                const values = {};
                const inputIds = ['a', 'b', 'c', 'd', 'e', 'f'];
                let hasError = false;

                inputIds.forEach(id => document.getElementById(id).classList.remove('error'));

                for (const id of inputIds) {
                    const inputEl = document.getElementById(id);
                    const parsedValue = parseInput(inputEl.value);
                    if (parsedValue === null) {
                        inputEl.classList.add('error');
                        hasError = true;
                    }
                    values[id] = parsedValue;
                }
                return hasError ? null : values;
            }

            function generateRandomEquations() {
                ['a', 'b', 'c', 'd', 'e', 'f'].forEach(id => {
                    document.getElementById(id).value = Math.floor(Math.random() * 21) - 10;
                });
                solve();
            }

            function resetSimulator() {
                 ['a', 'b', 'c', 'd', 'e', 'f'].forEach(id => {
                     const input = document.getElementById(id);
                     input.value = '';
                     input.classList.remove('error');
                 });
                 ['sustitucion', 'igualacion', 'reduccion', 'graph-info'].forEach(id => {
                     const el = document.getElementById(id);
                     if (el) el.innerHTML = '';
                 });
                 
                 graphContainer.classList.add('hidden');
                 graphPlaceholder.classList.remove('hidden');
                 showSolutionCheckbox.checked = false;

                 if (chartInstance) {
                     chartInstance.destroy();
                     chartInstance = null;
                 }
                 lastSolutionData = {};

                 document.querySelectorAll('.tab-content').forEach(panel => {
                    if(panel.id !== 'grafico') panel.innerHTML = '';
                 });
            }
            
            // --- FORMATTING FUNCTIONS ---

            function formatNumberSmart(num) {
                if (num === null || num === undefined) return '0';
                const numFloat = parseFloat(num);
                if (Math.abs(numFloat - Math.round(numFloat)) < 1e-9) {
                    return Math.round(numFloat).toString();
                } else {
                    return parseFloat(numFloat.toFixed(3)).toString().replace(/(\.0+|0+)$/, '');
                }
            }

            function formatLatexSign(num) {
                if (Math.abs(num) < 1e-9) return '';
                const absNum = Math.abs(num);
                const formattedNum = formatNumberSmart(absNum);
                return num < 0 ? `- ${formattedNum}` : `+ ${formattedNum}`;
            }
            
            function createStep(title, content) {
                return `<div class="solution-step">
                            <h4 class="font-semibold text-base mb-2 text-indigo-700">${title}</h4>
                            <div class="step-content">${content}</div>
                        </div>`;
            }

            function getActiveTab() {
                return document.querySelector('.tab-btn.active')?.dataset.tab || 'sustitucion';
            }

            // --- CORE SOLVER FUNCTIONS ---

            function solve() {
                const coeffs = getCoefficients();
                if (coeffs === null) {
                    showNotification("Por favor, revisa los campos en rojo. Asegúrate de que todos los valores son correctos, no están vacíos y no hay divisiones por cero.");
                    return;
                }

                lastSolutionData = { coeffs };
                const { a, b, c, d, e, f } = coeffs;
                const determinant = a * e - b * d;
                
                if (Math.abs(determinant) > 1e-9) {
                    lastSolutionData.solution = { x: (c * e - b * f) / determinant, y: (a * f - c * d) / determinant };
                    lastSolutionData.caseType = 'unica';
                } else {
                    lastSolutionData.solution = null;
                    lastSolutionData.caseType = (Math.abs(a * f - c * d) < 1e-9 && Math.abs(c * e - b * f) < 1e-9) ? "infinitas" : "paralelas";
                }
                
                solveBySustitucion(coeffs, lastSolutionData.solution, lastSolutionData.caseType);
                solveByIgualacion(coeffs, lastSolutionData.solution, lastSolutionData.caseType);
                solveByReduccion(coeffs, lastSolutionData.solution, lastSolutionData.caseType);

                const activeTab = getActiveTab();
                if (activeTab === 'grafico') {
                    solveByGrafico(lastSolutionData.coeffs, lastSolutionData.solution, lastSolutionData.caseType);
                }
                
                renderMathInElement(document.getElementById(activeTab));
            }

            function buildAlgebraicMethodUI(method, title, stepsHtml, solution, caseType) {
                let finalSolutionHtml = '';
                if (caseType === 'unica') {
                    finalSolutionHtml = `<div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-center">
                        <h4 class="text-base font-bold text-green-800">Solución Final</h4>
                        <p class="text-xl font-mono text-green-900 mt-1">$$ x = ${formatNumberSmart(solution.x)} \\quad , \\quad y = ${formatNumberSmart(solution.y)} $$</p>
                    </div>`;
                } else {
                    finalSolutionHtml = `<div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-center">
                        <h4 class="text-base font-bold text-yellow-800">${caseType === 'infinitas' ? 'Infinitas Soluciones' : 'Sin Solución'}</h4>
                        <p class="text-base text-yellow-900 mt-1">${caseType === 'infinitas' ? 'Las rectas son coincidentes.' : 'Las rectas son paralelas.'}</p>
                    </div>`;
                }

                let stepsToggleHtml = '';
                if (caseType === 'unica' && stepsHtml) {
                    stepsToggleHtml = `<div class="text-center my-4">
                        <label class="cursor-pointer text-base">
                            <input type="checkbox" class="show-steps-checkbox mr-2 align-middle rounded border-gray-400 text-indigo-600 focus:ring-indigo-500" data-target="steps-${method}">
                            Mostrar paso a paso
                        </label>
                    </div>
                    <div id="steps-${method}" class="hidden">
                        ${stepsHtml}
                    </div>`;
                }

                const container = document.getElementById(method);
                container.innerHTML = `<h3 class="text-xl font-bold mb-4 text-center">${title}</h3>${finalSolutionHtml}${stepsToggleHtml}`;
            }
            
            // --- ALGEBRAIC METHOD IMPLEMENTATIONS ---
            function solveBySustitucion({a, b, c, d, e, f}, solution, caseType) {
                let stepsHtml = '';
                if (caseType === 'unica') {
                    const {x, y} = solution;
                     if (Math.abs(b) > 1e-9) {
                        stepsHtml += createStep('1. Despejar $y$ en la 1ª ecuación', `$$ ${formatNumberSmart(a)}x ${formatLatexSign(b)}y = ${formatNumberSmart(c)} \\implies y = \\frac{${formatNumberSmart(c)} ${formatLatexSign(-a)}x}{${formatNumberSmart(b)}} $$`);
                        stepsHtml += createStep('2. Sustituir $y$ en la 2ª ecuación', `$$ ${formatNumberSmart(d)}x ${formatLatexSign(e)}\\left(\\frac{${formatNumberSmart(c)} ${formatLatexSign(-a)}x}{${formatNumberSmart(b)}}\\right) = ${formatNumberSmart(f)} $$`);
                        stepsHtml += createStep('3. Resolver para $x$', `Despejando y simplificando se obtiene: $$ x = ${formatNumberSmart(x)} $$`);
                        stepsHtml += createStep('4. Encontrar $y$ usando $x$', `$$ y = \\frac{${formatNumberSmart(c)} ${formatLatexSign(-a)}(${formatNumberSmart(x)})}{${formatNumberSmart(b)}} \\implies y = ${formatNumberSmart(y)} $$`);
                     } else if (Math.abs(a) > 1e-9) {
                         stepsHtml += createStep('1. Despejar $x$ en la 1ª ecuación', `$$ ${formatNumberSmart(a)}x = ${formatNumberSmart(c)} ${formatLatexSign(-b)}y \\implies x = \\frac{${formatNumberSmart(c)} ${formatLatexSign(-b)}y}{${formatNumberSmart(a)}} $$`);
                         stepsHtml += createStep('2. Sustituir $x$ en la 2ª ecuación', `$$ ${formatNumberSmart(d)}\\left(\\frac{${formatNumberSmart(c)} ${formatLatexSign(-b)}y}{${formatNumberSmart(a)}}\\right) ${formatLatexSign(e)}y = ${formatNumberSmart(f)} $$`);
                         stepsHtml += createStep('3. Resolver para $y$', `Despejando y simplificando se obtiene: $$ y = ${formatNumberSmart(y)} $$`);
                         stepsHtml += createStep('4. Encontrar $x$ usando $y$', `$$ x = \\frac{${formatNumberSmart(c)} ${formatLatexSign(-b)}(${formatNumberSmart(y)})}{${formatNumberSmart(a)}} \\implies x = ${formatNumberSmart(x)} $$`);
                    } else {
                        stepsHtml = createStep('Error', 'No se puede despejar en la primera ecuación.');
                    }
                }
                buildAlgebraicMethodUI('sustitucion', 'Método de Sustitución', stepsHtml, solution, caseType);
            }

            function solveByIgualacion({a, b, c, d, e, f}, solution, caseType) {
                let stepsHtml = '';
                if (caseType === 'unica') {
                    const {x, y} = solution;
                     if (Math.abs(a) > 1e-9 && Math.abs(d) > 1e-9) {
                        stepsHtml += createStep('1. Despejar $x$ en ambas ecuaciones', `Ec. 1: $$ x = \\frac{${formatNumberSmart(c)} ${formatLatexSign(-b)}y}{${formatNumberSmart(a)}} $$ Ec. 2: $$ x = \\frac{${formatNumberSmart(f)} ${formatLatexSign(-e)}y}{${formatNumberSmart(d)}} $$`);
                        stepsHtml += createStep('2. Igualar las expresiones para $x$', `$$ \\frac{${formatNumberSmart(c)} ${formatLatexSign(-b)}y}{${formatNumberSmart(a)}} = \\frac{${formatNumberSmart(f)} ${formatLatexSign(-e)}y}{${formatNumberSmart(d)}} $$`);
                        stepsHtml += createStep('3. Resolver para $y$', `Despejando y simplificando se obtiene: $$ y = ${formatNumberSmart(y)} $$`);
                        stepsHtml += createStep('4. Encontrar $x$ usando $y$', `$$ x = \\frac{${formatNumberSmart(c)} ${formatLatexSign(-b)}(${formatNumberSmart(y)})}{${formatNumberSmart(a)}} \\implies x = ${formatNumberSmart(x)} $$`);
                     } else if (Math.abs(b) > 1e-9 && Math.abs(e) > 1e-9) {
                        stepsHtml += createStep('1. Despejar $y$ en ambas ecuaciones', `Ec. 1: $$ y = \\frac{${formatNumberSmart(c)} ${formatLatexSign(-a)}x}{${formatNumberSmart(b)}} $$ Ec. 2: $$ y = \\frac{${formatNumberSmart(f)} ${formatLatexSign(-d)}x}{${formatNumberSmart(e)}} $$`);
                        stepsHtml += createStep('2. Igualar las expresiones para $y$', `$$ \\frac{${formatNumberSmart(c)} ${formatLatexSign(-a)}x}{${formatNumberSmart(b)}} = \\frac{${formatNumberSmart(f)} ${formatLatexSign(-d)}x}{${formatNumberSmart(e)}} $$`);
                        stepsHtml += createStep('3. Resolver para $x$', `Despejando y simplificando se obtiene: $$ x = ${formatNumberSmart(x)} $$`);
                        stepsHtml += createStep('4. Encontrar $y$ usando $x$', `$$ y = \\frac{${formatNumberSmart(c)} ${formatLatexSign(-a)}(${formatNumberSmart(x)})}{${formatNumberSmart(b)}} \\implies y = ${formatNumberSmart(y)} $$`);
                    } else {
                        stepsHtml = createStep('Error', 'No se puede despejar la misma variable en ambas ecuaciones.');
                    }
                }
                buildAlgebraicMethodUI('igualacion', 'Método de Igualación', stepsHtml, solution, caseType);
            }

            function solveByReduccion({a, b, c, d, e, f}, solution, caseType) {
                // Special case: One of the variables is already eliminated.
                if (caseType === 'unica' && (a === 0 || b === 0 || d === 0 || e === 0)) {
                    const container = document.getElementById('reduccion');
                    const finalSolutionHtml = `<div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-center">
                        <h4 class="text-base font-bold text-green-800">Solución Final</h4>
                        <p class="text-xl font-mono text-green-900 mt-1">$$ x = ${formatNumberSmart(solution.x)} \\quad , \\quad y = ${formatNumberSmart(solution.y)} $$</p>
                    </div>`;
                    
                    const explanationHtml = createStep(
                        'Nota sobre el Método de Reducción',
                        `Cuando el coeficiente de una variable es 0, esa variable ya está prácticamente despejada en una de las ecuaciones. <br><br> En estos casos, el método de reducción no es el más práctico. La solución se encuentra de forma mucho más directa por <b>sustitución</b>.`
                    );

                    container.innerHTML = `<h3 class="text-xl font-bold mb-4 text-center">Método de Reducción</h3>${finalSolutionHtml}${explanationHtml}`;
                    renderMathInElement(container); // Render LaTeX in the new content
                    return; // Exit the function after handling the special case
                }

                // Default case: Standard reduction method
                let stepsHtml = '';
                if (caseType === 'unica') {
                    const {x, y} = solution;
                    const step1Content = `$$ \\begin{cases} (${formatNumberSmart(a)})x ${formatLatexSign(b)}y = ${formatNumberSmart(c)} & \\xrightarrow{\\times ${formatNumberSmart(d)}} \\\\ (${formatNumberSmart(d)})x ${formatLatexSign(e)}y = ${formatNumberSmart(f)} & \\xrightarrow{\\times ${formatNumberSmart(-a)}} \\end{cases} \\quad \\implies \\quad \\begin{cases} ${formatNumberSmart(a*d)}x ${formatLatexSign(b*d)}y = ${formatNumberSmart(c*d)} \\\\ ${formatNumberSmart(d*(-a))}x ${formatLatexSign(e*(-a))}y = ${formatNumberSmart(f*(-a))} \\end{cases} $$`;
                    stepsHtml += createStep('1. Multiplicar para eliminar $x$', step1Content);
                    stepsHtml += createStep('2. Sumar las nuevas ecuaciones para encontrar $y$', `Al sumar las dos ecuaciones, el término con $x$ se cancela: $$ (${formatNumberSmart(b*d + e*-a)})y = ${formatNumberSmart(c*d + f*-a)} \\implies y = ${formatNumberSmart(y)} $$`);
                    stepsHtml += createStep('3. Encontrar $x$ sustituyendo $y$ en la Ec. 1', `$$ ${formatNumberSmart(a)}x ${formatLatexSign(b)}(${formatNumberSmart(y)}) = ${formatNumberSmart(c)} \\implies x = ${formatNumberSmart(x)} $$`);
                }
                
                // Use the generic builder for standard cases (unica, infinitas, paralelas)
                buildAlgebraicMethodUI('reduccion', 'Método de Reducción', stepsHtml, solution, caseType);
            }

            // --- GRAPHICAL METHOD IMPLEMENTATION ---

            let handleZoom; // Declare here to be accessible in chart options

            function solveByGrafico({a, b, c, d, e, f}, solution, caseType) {
                graphContainer.classList.remove('hidden');
                graphPlaceholder.classList.add('hidden');
                zoomControls.classList.remove('hidden');
                
                const graphInfoDiv = document.getElementById('graph-info');
                
                let eq1Text = (Math.abs(b) > 1e-9) 
                    ? `Recta 1 (azul): $y = ${formatNumberSmart(-a/b)}x ${formatLatexSign(c/b)}$`
                    : `Recta 1 (azul): $x = ${formatNumberSmart(c/a)}$ (Recta Vertical)`;
                let eq2Text = (Math.abs(e) > 1e-9)
                    ? `Recta 2 (roja): $y = ${formatNumberSmart(-d/e)}x ${formatLatexSign(f/e)}$`
                    : `Recta 2 (roja): $x = ${formatNumberSmart(f/d)}$ (Recta Vertical)`;
                
                graphInfoDiv.innerHTML = createStep('Ecuaciones en forma explícita ($y=mx+n$)', `${eq1Text}<br>${eq2Text}`);
                renderMathInElement(graphInfoDiv);

                const canvas = document.getElementById('chart');
                if (!canvas) return;
                if (chartInstance) chartInstance.destroy();

                const generateLineData = (m, n, range) => [{x: range.min, y: m * range.min + n}, {x: range.max, y: m * range.max + n}];
                const generateVerticalLineData = (k, range) => [{x: k, y: range.min}, {x: k, y: range.max}];

                let minX, maxX, minY, maxY;
                const PADDING = 10;
                if (caseType === 'unica' && solution) {
                    const solX = parseFloat(solution.x);
                    const solY = parseFloat(solution.y);
                    minX = solX - PADDING;
                    maxX = solX + PADDING;
                    minY = solY - PADDING;
                    maxY = solY + PADDING;
                } else {
                    minX = -PADDING; maxX = PADDING;
                    minY = -PADDING; maxY = PADDING;
                }

                const initialXRange = { min: minX, max: maxX };
                const initialYRange = { min: minY, max: maxY };

                let line1InitialData = (Math.abs(b) > 1e-9) ? generateLineData(-a / b, c / b, initialXRange) : (Math.abs(a) > 1e-9 ? generateVerticalLineData(c / a, initialYRange) : []);
                let line2InitialData = (Math.abs(e) > 1e-9) ? generateLineData(-d / e, f / e, initialXRange) : (Math.abs(d) > 1e-9 ? generateVerticalLineData(f / d, initialYRange) : []);
                
                const datasets = [
                    { label: `Recta 1`, borderColor: '#3b82f6', borderWidth: 2.5, fill: false, pointRadius: 0, type: 'line', data: line1InitialData },
                    { label: `Recta 2`, borderColor: '#ef4444', borderWidth: 2.5, fill: false, pointRadius: 0, type: 'line', data: line2InitialData }
                ];
                
                let chartTitle = 'Gráfico del Sistema';
                if (caseType === 'unica' && showSolutionCheckbox.checked) {
                    datasets.push({ label: `Solución`, data: [solution], backgroundColor: '#f59e0b', pointRadius: 8, pointHoverRadius: 10, type: 'scatter' });
                    chartTitle = `Punto de corte: (${formatNumberSmart(solution.x)}, ${formatNumberSmart(solution.y)})`;
                } else if (caseType === 'infinitas') {
                    chartTitle = "Infinitas Soluciones: Las rectas son coincidentes.";
                    datasets[1].borderColor = '#60a5fa';
                    datasets[1].borderDash = [5, 5];
                } else if (caseType === 'paralelas') {
                    chartTitle = "Sin Solución: Las rectas son paralelas.";
                }

                handleZoom = (chart) => {
                    if (!chart || !chart.scales || !chart.scales.x) return;
                    if (caseType === 'unica' && solution) {
                        const solX = parseFloat(solution.x);
                        const solY = parseFloat(solution.y);
                        const width = chart.scales.x.max - chart.scales.x.min;
                        const height = chart.scales.y.max - chart.scales.y.min;
                        chart.scales.x.min = solX - width / 2;
                        chart.scales.x.max = solX + width / 2;
                        chart.scales.y.min = solY - height / 2;
                        chart.scales.y.max = solY + height / 2;
                    }

                    const xRange = { min: chart.scales.x.min, max: chart.scales.x.max };
                    const yRange = { min: chart.scales.y.min, max: chart.scales.y.max };
                    
                    chart.data.datasets[0].data = (Math.abs(b) > 1e-9) ? generateLineData(-a/b, c/b, xRange) : (Math.abs(a) > 1e-9 ? generateVerticalLineData(c/a, yRange) : []);
                    chart.data.datasets[1].data = (Math.abs(e) > 1e-9) ? generateLineData(-d/e, f/e, xRange) : (Math.abs(d) > 1e-9 ? generateVerticalLineData(f/d, yRange) : []);
                    chart.update('none');
                };
                
                const isPanEnabled = caseType !== 'unica';

                chartInstance = new Chart(document.getElementById('chart').getContext('2d'), {
                    data: { datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { type: 'linear', position: 'bottom', min: minX, max: maxX, title: { display: true, text: 'Eje X' }, grid: { color: (c) => c.tick.value === 0 ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.1)', lineWidth: (c) => c.tick.value === 0 ? 2 : 1 }},
                            y: { min: minY, max: maxY, title: { display: true, text: 'Eje Y' }, grid: { color: (c) => c.tick.value === 0 ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.1)', lineWidth: (c) => c.tick.value === 0 ? 2 : 1 }}
                        },
                        plugins: {
                            title: { display: true, text: chartTitle, font: { size: 16 } },
                            legend: { position: 'top', labels: { font: { size: 12 } } },
                            zoom: {
                                pan: { enabled: isPanEnabled, mode: 'xy', onPanComplete: ({chart}) => handleZoom(chart) },
                                zoom: {
                                    drag: { enabled: false },
                                    wheel: { enabled: true }, 
                                    pinch: { enabled: true }, 
                                    mode: 'xy', 
                                    onZoomComplete: ({chart}) => handleZoom(chart)
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
