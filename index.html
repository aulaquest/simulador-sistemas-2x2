<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Ecuaciones Lineales 2x2 (Fraccionario)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Plugin para zoom y pan en el gráfico -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMVIUpYHmvsplGIZjQsLMRdQSYNGEQUCmMvKCnmK2BqH0iK38" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            flex-grow: 1;
        }
        .tab-btn {
            transition: all 0.3s ease;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .tab-btn.active {
            border-color: #4f46e5;
            background-color: #4f46e5;
            color: white;
        }
        .solution-step {
            background-color: #f9fafb;
            border-left: 3px solid #6366f1;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.25rem;
        }
        .step-content {
            overflow-x: auto; /* Permite scroll horizontal en ecuaciones largas */
            padding-bottom: 0.5rem; /* Espacio para la barra de scroll */
        }
        .input-field {
            width: 55px;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.25rem;
            font-size: 1rem;
            -moz-appearance: textfield;
        }
        .input-field.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 2px #fecaca;
        }
        .input-field::-webkit-outer-spin-button,
        .input-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .katex-display > .katex {
             white-space: nowrap; /* Evita que KaTeX rompa la línea */
        }
        #chart {
            touch-action: none; 
        }
        #notification-modal {
            transition: opacity 0.3s ease;
        }
        .zoom-btn {
            width: 40px;
            height: 40px;
            font-size: 24px;
            line-height: 1;
        }
        /* New styles for step-by-step and variable choice */
        .toggle-steps-label {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: #eef2ff;
            color: #4338ca;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .toggle-steps-label:hover {
            background-color: #e0e7ff;
        }
        .toggle-steps-checkbox {
            display: none;
        }
        .variable-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
        }
        .variable-selector .description {
            font-weight: 500;
            color: #374151;
        }
        .variable-selector-label {
            display: block;
        }
        .variable-selector-label input {
            display: none;
        }
        .variable-selector-label span {
            display: block;
            padding: 0.4rem 1.2rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .variable-selector-label input:checked + span {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .variable-selector-label input:disabled + span {
            opacity: 0.5;
            background-color: #e5e7eb;
            cursor: not-allowed;
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Notification Modal -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Error de Entrada</h3>
            <div class="mt-2 px-7 py-3">
                <p id="notification-message" class="text-sm text-gray-600">
                    Mensaje de error aquí.
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="notification-close-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">
                    Entendido
                </button>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-3 md:p-4 max-w-4xl">
        
        <div class="bg-white p-5 rounded-lg shadow-md border border-gray-200 mb-6">
            
            <div class="flex items-center justify-center">
                <div class="text-7xl font-light mr-4 text-gray-400" style="line-height: 1;">{</div>
                <div class="flex flex-col space-y-3">
                    <div class="flex items-center space-x-2 text-lg">
                        <input id="a" type="text" class="input-field" placeholder="a">
                        <span class="font-semibold">x +</span>
                        <input id="b" type="text" class="input-field" placeholder="b">
                        <span class="font-semibold">y =</span>
                        <input id="c" type="text" class="input-field" placeholder="c">
                    </div>
                    <div class="flex items-center space-x-2 text-lg">
                        <input id="d" type="text" class="input-field" placeholder="d">
                        <span class="font-semibold">x +</span>
                        <input id="e" type="text" class="input-field" placeholder="e">
                        <span class="font-semibold">y =</span>
                        <input id="f" type="text" class="input-field" placeholder="f">
                    </div>
                </div>
            </div>
             <div class="text-center text-gray-500 text-xs mt-4">
                 <p>Puedes usar <strong>enteros</strong> (p. ej. `5`), <strong>racionales</strong> (p. ej. `3/4`) y <strong>decimales</strong> (p. ej. `1.5` o `1,5`).</p>
                 <p>Los decimales se convertirán automáticamente a su fracción equivalente.</p>
             </div>
            <div class="mt-5 flex justify-center space-x-3">
                <button id="solveBtn" class="bg-indigo-600 text-white font-semibold py-2 px-5 text-base rounded-lg hover:bg-indigo-700 transition duration-300 shadow-sm">Resolver</button>
                <button id="randomBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-5 text-base rounded-lg hover:bg-gray-300 transition duration-300">Aleatorio</button>
                <button id="resetBtn" class="bg-red-500 text-white font-semibold py-2 px-5 text-base rounded-lg hover:bg-red-600 transition duration-300">Reiniciar</button>
            </div>
        </div>

        <div class="mb-5">
            <div class="flex flex-wrap justify-center border-b border-gray-300">
                <button class="tab-btn active font-medium border-b-2 border-transparent rounded-t-md" data-tab="sustitucion">Sustitución</button>
                <button class="tab-btn font-medium border-b-2 border-transparent rounded-t-md" data-tab="igualacion">Igualación</button>
                <button class="tab-btn font-medium border-b-2 border-transparent rounded-t-md" data-tab="reduccion">Reducción</button>
                <button class="tab-btn font-medium border-b-2 border-transparent rounded-t-md" data-tab="grafico">Gráfico</button>
            </div>
        </div>

        <div id="contentPanels" class="bg-white p-4 md:p-6 rounded-lg shadow-md border border-gray-200 min-h-[400px]">
            <div id="sustitucion" class="tab-content"></div>
            <div id="igualacion" class="tab-content hidden"></div>
            <div id="reduccion" class="tab-content hidden"></div>
            <div id="grafico" class="tab-content hidden">
                 <div id="graph-container" class="hidden">
                     <div id="graph-info"></div>
                     <div class="text-center my-3">
                         <label for="showSolutionCheckbox" class="cursor-pointer text-base">
                             <input type="checkbox" id="showSolutionCheckbox" class="mr-2 align-middle rounded border-gray-400 text-indigo-600 focus:ring-indigo-500">
                             Mostrar punto de corte
                         </label>
                     </div>
                     <div class="relative" style="height: 65vh; max-height: 500px;">
                         <canvas id="chart"></canvas>
                          <!-- Zoom Buttons -->
                         <div id="zoom-controls" class="absolute bottom-4 right-4 flex flex-col space-y-2">
                             <button id="zoom-in-btn" class="zoom-btn bg-gray-800 text-white rounded-full shadow-lg hover:bg-gray-700 transition">+</button>
                             <button id="zoom-out-btn" class="zoom-btn bg-gray-800 text-white rounded-full shadow-lg hover:bg-gray-700 transition">-</button>
                         </div>
                     </div>
                 </div>
                 <div id="graph-placeholder" class="text-center text-gray-500 pt-16">
                     <p>Introduce los coeficientes del sistema de ecuaciones y pulsa "Resolver" para generar el gráfico.</p>
                 </div>
            </div>
        </div>
    </div>
    
    <footer class="text-center p-4 text-gray-500 text-sm">
        Simulación creada por <a href="https://aulaquest.com" target="_blank" class="text-indigo-600 hover:underline font-semibold">AulaQuest</a>
    </footer>

    <script>
        /**
         * ----------------------------------------------------------------
         * Objeto para manejar Fracciones (aritmética y formato)
         * ----------------------------------------------------------------
         */
        const Fraction = {
            // Máximo común divisor (Euclidean algorithm)
            gcd: (a, b) => {
                a = Math.abs(a);
                b = Math.abs(b);
                while (b) {
                    [a, b] = [b, a % b];
                }
                return a;
            },

            // Simplifica una fracción
            simplify: ({ num, den }) => {
                if (den === 0) {
                    throw new Error("Denominator cannot be zero.");
                }
                if (num === 0) {
                    return { num: 0, den: 1 };
                }
                const commonDivisor = Fraction.gcd(num, den);
                let simplifiedNum = num / commonDivisor;
                let simplifiedDen = den / commonDivisor;
                
                // Ensure sign is on the numerator
                if (simplifiedDen < 0) {
                    simplifiedDen = -simplifiedDen;
                    simplifiedNum = -simplifiedNum;
                }
                
                return { num: simplifiedNum, den: simplifiedDen };
            },
            
            // Crea una fracción desde un string o número
            create: (value) => {
                if (typeof value === 'object' && value !== null && 'num' in value && 'den' in value) {
                    return value; // Already a fraction
                }
                if (value === null || String(value).trim() === '') return null;
                
                let strValue = String(value).trim().replace(',', '.');
                
                if (strValue.includes('/')) {
                    const parts = strValue.split('/');
                    if (parts.length === 2) {
                        const num = parseInt(parts[0], 10);
                        const den = parseInt(parts[1], 10);
                        if (!isNaN(num) && !isNaN(den) && den !== 0) {
                            return Fraction.simplify({ num, den });
                        }
                    }
                    return null; // Invalid fraction format
                } else {
                    const num = parseFloat(strValue);
                    if (isNaN(num)) return null;

                    if (Number.isInteger(num)) {
                        return { num: num, den: 1 };
                    } else {
                        // Convert decimal to fraction
                        const len = strValue.split('.')[1].length;
                        const den = Math.pow(10, len);
                        const numInt = num * den;
                        return Fraction.simplify({ num: Math.round(numInt), den: den });
                    }
                }
            },
            
            // Operaciones Aritméticas
            add: (f1, f2) => Fraction.simplify({ num: f1.num * f2.den + f2.num * f1.den, den: f1.den * f2.den }),
            subtract: (f1, f2) => Fraction.simplify({ num: f1.num * f2.den - f2.num * f1.den, den: f1.den * f2.den }),
            multiply: (f1, f2) => Fraction.simplify({ num: f1.num * f2.num, den: f1.den * f2.den }),
            divide: (f1, f2) => {
                if (f2.num === 0) throw new Error("Division by zero fraction.");
                return Fraction.simplify({ num: f1.num * f2.den, den: f1.den * f2.num });
            },
            negate: (f) => ({ num: -f.num, den: f.den }),
            
            // Utilidades de formato y comparación
            isZero: (f) => f.num === 0,
            isOne: (f) => f.num === 1 && f.den === 1,
            isNegativeOne: (f) => f.num === -1 && f.den === 1,
            
            toDecimal: (f) => f.num / f.den,

            // Formato para display (normal y LaTeX)
            format: (f, latex = false, forceSign = false) => {
                if (f.den === 1) {
                    const sign = f.num >= 0 && forceSign ? '+' : '';
                    return sign + f.num.toString();
                }
                if (f.num === 0) {
                     return forceSign ? '+ 0' : '0';
                }
                if (latex) {
                    let sign = f.num < 0 ? '-' : (forceSign ? '+' : '');
                    if (f.num < 0) {
                       return `- \\frac{${Math.abs(f.num)}}{${f.den}}`;
                    }
                    return `${sign} \\frac{${f.num}}{${f.den}}`;
                }
                return `${f.num}/${f.den}`;
            },

            formatForEquation: (f, variable, isFirst = false) => {
                if (Fraction.isZero(f)) return "";

                let sign = f.num < 0 ? "-" : "+";
                let absF = { num: Math.abs(f.num), den: f.den };

                if (isFirst) {
                    sign = f.num < 0 ? "-" : "";
                }
                
                let coeffStr = "";
                if (Fraction.isOne(absF) || Fraction.isNegativeOne(absF)) {
                    coeffStr = variable;
                } else {
                    coeffStr = `${Fraction.format(absF, true)}${variable}`;
                }
                
                return isFirst ? `${sign}${coeffStr}` : ` ${sign} ${coeffStr}`;
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            // Register the zoom plugin with Chart.js
            if(window.ChartZoom) Chart.register(ChartZoom);

            // Get DOM elements
            const solveBtn = document.getElementById('solveBtn');
            const randomBtn = document.getElementById('randomBtn');
            const resetBtn = document.getElementById('resetBtn');
            const tabs = document.querySelectorAll('.tab-btn');
            const contentPanels = document.getElementById('contentPanels');
            const showSolutionCheckbox = document.getElementById('showSolutionCheckbox');
            const graphContainer = document.getElementById('graph-container');
            const graphPlaceholder = document.getElementById('graph-placeholder');
            const notificationModal = document.getElementById('notification-modal');
            const notificationMessage = document.getElementById('notification-message');
            const notificationCloseBtn = document.getElementById('notification-close-btn');
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            const zoomControls = document.getElementById('zoom-controls');

            // State variables
            let chartInstance = null;
            let lastSolutionData = {};

            // --- EVENT LISTENERS ---
            solveBtn.addEventListener('click', solve);
            randomBtn.addEventListener('click', generateRandomEquations);
            resetBtn.addEventListener('click', resetSimulator);
            
            showSolutionCheckbox.addEventListener('change', () => {
                if(getActiveTab() === 'grafico' && lastSolutionData.coeffs) {
                    solveByGrafico(lastSolutionData.coeffs, lastSolutionData.solution, lastSolutionData.caseType);
                }
            });

            notificationCloseBtn.addEventListener('click', () => {
                notificationModal.classList.add('hidden');
            });

            zoomInBtn.addEventListener('click', () => chartInstance?.zoom(1.1));
            zoomOutBtn.addEventListener('click', () => chartInstance?.zoom(0.9));
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(p => p.classList.add('hidden'));
                    
                    tab.classList.add('active');
                    const activeTabContent = document.getElementById(tab.dataset.tab);
                    activeTabContent.classList.remove('hidden');
                    
                    if (Object.keys(lastSolutionData).length > 0) {
                        if (tab.dataset.tab === 'grafico') {
                            solveByGrafico(lastSolutionData.coeffs, lastSolutionData.solution, lastSolutionData.caseType);
                        }
                        renderMathInElement(activeTabContent);
                    }
                });
            });

            contentPanels.addEventListener('change', function(e) {
                if (e.target.classList.contains('toggle-steps-checkbox')) {
                    const targetId = e.target.dataset.target;
                    document.getElementById(targetId)?.classList.toggle('hidden');
                }
                
                // Handle variable choice changes
                if (e.target.name && e.target.name.endsWith('-var')) {
                    const method = e.target.name.split('-')[0];
                    const variable = e.target.value;
                    const { coeffs, solution, caseType } = lastSolutionData;
                    if (!coeffs) return;

                    let newStepsHtml = '';
                    switch (method) {
                        case 'sustitucion':
                            newStepsHtml = getSustitucionStepsHtml({ ...coeffs, solution, caseType, variable });
                            break;
                        case 'igualacion':
                            newStepsHtml = getIgualacionStepsHtml({ ...coeffs, solution, caseType, variable });
                            break;
                        case 'reduccion':
                            newStepsHtml = getReduccionStepsHtml({ ...coeffs, solution, caseType, variable });
                            break;
                    }

                    const stepsContentDiv = document.getElementById(`steps-content-${method}`);
                    if (stepsContentDiv) {
                        stepsContentDiv.innerHTML = newStepsHtml;
                        renderMathInElement(stepsContentDiv);
                    }
                }
            });
            
            // --- UTILITY FUNCTIONS ---
            function showNotification(message) {
                notificationMessage.textContent = message;
                notificationModal.classList.remove('hidden');
            }

            function renderMathInElement(elem) {
                if (elem && window.renderMathInElement) {
                    window.renderMathInElement(elem, {
                        delimiters: [ {left: "$$", right: "$$", display: true}, {left: "$", right: "$", display: false} ],
                        throwOnError: false
                    });
                }
            }
            
            function getCoefficients() {
                const values = {};
                const inputIds = ['a', 'b', 'c', 'd', 'e', 'f'];
                let hasError = false;

                inputIds.forEach(id => document.getElementById(id).classList.remove('error'));

                for (const id of inputIds) {
                    const inputEl = document.getElementById(id);
                    const parsedValue = Fraction.create(inputEl.value);
                    if (parsedValue === null) {
                        inputEl.classList.add('error');
                        hasError = true;
                    }
                    values[id] = parsedValue;
                }
                return hasError ? null : values;
            }

            function generateRandomEquations() {
                ['a', 'b', 'c', 'd', 'e', 'f'].forEach(id => {
                    document.getElementById(id).value = Math.floor(Math.random() * 21) - 10;
                });
                solve();
            }

            function resetSimulator() {
                 ['a', 'b', 'c', 'd', 'e', 'f'].forEach(id => {
                     const input = document.getElementById(id);
                     input.value = '';
                     input.classList.remove('error');
                 });
                 ['sustitucion', 'igualacion', 'reduccion', 'graph-info'].forEach(id => {
                     const el = document.getElementById(id);
                     if (el) el.innerHTML = '';
                 });
                 
                 graphContainer.classList.add('hidden');
                 graphPlaceholder.classList.remove('hidden');
                 showSolutionCheckbox.checked = false;

                 if (chartInstance) {
                     chartInstance.destroy();
                     chartInstance = null;
                 }
                 lastSolutionData = {};

                 document.querySelectorAll('.tab-content').forEach(panel => {
                     if(panel.id !== 'grafico') panel.innerHTML = '';
                 });
            }
            
            // --- FORMATTING FUNCTIONS ---

            function createStep(title, content) {
                return `<div class="solution-step">
                            <h4 class="font-semibold text-base mb-2 text-indigo-700">${title}</h4>
                            <div class="step-content">${content}</div>
                        </div>`;
            }

            function getActiveTab() {
                return document.querySelector('.tab-btn.active')?.dataset.tab || 'sustitucion';
            }

            // --- CORE SOLVER FUNCTIONS ---

            function solve() {
                const coeffs = getCoefficients();
                if (coeffs === null) {
                    showNotification("Por favor, revisa los campos en rojo. Asegúrate de que todos los valores son correctos, no están vacíos y no hay divisiones por cero.");
                    return;
                }

                lastSolutionData = { coeffs };
                const { a, b, c, d, e, f } = coeffs;
                // determinant = a*e - b*d
                const determinant = Fraction.subtract(Fraction.multiply(a, e), Fraction.multiply(b, d));
                
                if (!Fraction.isZero(determinant)) {
                    // x = (c*e - b*f) / determinant
                    const x_num = Fraction.subtract(Fraction.multiply(c, e), Fraction.multiply(b, f));
                    // y = (a*f - c*d) / determinant
                    const y_num = Fraction.subtract(Fraction.multiply(a, f), Fraction.multiply(c, d));
                    
                    lastSolutionData.solution = { 
                        x: Fraction.divide(x_num, determinant),
                        y: Fraction.divide(y_num, determinant)
                    };
                    lastSolutionData.caseType = 'unica';
                } else {
                    lastSolutionData.solution = null;
                    const check1 = Fraction.subtract(Fraction.multiply(a, f), Fraction.multiply(c, d));
                    const check2 = Fraction.subtract(Fraction.multiply(c, e), Fraction.multiply(b, f));
                    lastSolutionData.caseType = (Fraction.isZero(check1) && Fraction.isZero(check2)) ? "infinitas" : "paralelas";
                }
                
                solveBySustitucion(coeffs, lastSolutionData.solution, lastSolutionData.caseType);
                solveByIgualacion(coeffs, lastSolutionData.solution, lastSolutionData.caseType);
                solveByReduccion(coeffs, lastSolutionData.solution, lastSolutionData.caseType);

                const activeTab = getActiveTab();
                if (activeTab === 'grafico') {
                    solveByGrafico(lastSolutionData.coeffs, lastSolutionData.solution, lastSolutionData.caseType);
                }
                
                const activePanel = document.getElementById(activeTab);
                if (activePanel) {
                    renderMathInElement(activePanel);
                }
            }

            function buildAlgebraicMethodUI(method, title, stepsHtml, solution, caseType, options = {}) {
                let finalSolutionHtml = '';
                if (caseType === 'unica') {
                    finalSolutionHtml = `<div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-center">
                        <h4 class="text-base font-bold text-green-800">Solución Final</h4>
                        <p class="text-xl font-mono text-green-900 mt-1">$$ x = ${Fraction.format(solution.x, true)} \\quad , \\quad y = ${Fraction.format(solution.y, true)} $$</p>
                    </div>`;
                } else {
                    finalSolutionHtml = `<div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-center">
                        <h4 class="text-base font-bold text-yellow-800">${caseType === 'infinitas' ? 'Infinitas Soluciones' : 'Sin Solución'}</h4>
                        <p class="text-base text-yellow-900 mt-1">${caseType === 'infinitas' ? 'Las rectas son coincidentes.' : 'Las rectas son paralelas.'}</p>
                    </div>`;
                }

                let variableSelectorHtml = '';
                if (caseType === 'unica' && options.variable && options.available) {
                    const varX_checked = options.variable === 'x' ? 'checked' : '';
                    const varY_checked = options.variable === 'y' ? 'checked' : '';
                    const varX_disabled = !options.available.includes('x') ? 'disabled' : '';
                    const varY_disabled = !options.available.includes('y') ? 'disabled' : '';

                    let description = '';
                    if (method === 'sustitucion') description = 'Despejar en Ec. 1:';
                    if (method === 'igualacion') description = 'Igualar por variable:';
                    if (method === 'reduccion') description = 'Eliminar variable:';

                    variableSelectorHtml = `
                        <div class="variable-selector">
                            <span class="description">${description}</span>
                            <label class="variable-selector-label">
                                <input type="radio" name="${method}-var" value="x" ${varX_checked} ${varX_disabled}>
                                <span>X</span>
                            </label>
                            <label class="variable-selector-label">
                                <input type="radio" name="${method}-var" value="y" ${varY_checked} ${varY_disabled}>
                                <span>Y</span>
                            </label>
                        </div>
                    `;
                }

                let stepsToggleHtml = '';
                if (stepsHtml) {
                     stepsToggleHtml = `<div class="text-center my-4">
                        <label class="toggle-steps-label">
                           <input type="checkbox" class="toggle-steps-checkbox" data-target="steps-container-${method}">
                           Mostrar paso a paso
                        </label>
                    </div>
                    <div id="steps-container-${method}" class="hidden">
                        ${variableSelectorHtml}
                        <div id="steps-content-${method}">${stepsHtml}</div>
                    </div>`;
                }


                const container = document.getElementById(method);
                container.innerHTML = `<h3 class="text-xl font-bold mb-4 text-center">${title}</h3>${finalSolutionHtml}${stepsToggleHtml}`;
            }
            
            // --- ALGEBRAIC METHOD IMPLEMENTATIONS ---

            function getSustitucionStepsHtml({a, b, c, d, e, f, solution, caseType, variable}) {
                if (caseType !== 'unica' || !variable) return '';
                const { x, y } = solution;
                let stepsHtml = '';
                if (variable === 'y') {
                    const y_const = Fraction.divide(c, b);
                    const y_x_coeff = Fraction.divide(Fraction.negate(a), b);
                    const y_expr_str = `${Fraction.format(y_const, true)} ${Fraction.formatForEquation(y_x_coeff, 'x')}`;
                    stepsHtml += createStep('1. Despejar $y$ en la 1ª ecuación', `$$... \\implies y = ${y_expr_str} $$`);
                    stepsHtml += createStep('2. Sustituir $y$ en la 2ª ecuación', `$$ ${Fraction.formatForEquation(d, 'x', true)} ${Fraction.formatForEquation(e, '')} \\left( ${y_expr_str} \\right) = ${Fraction.format(f, true)} $$`);
                    stepsHtml += createStep('3. Resolver para $x$', `$$... \\implies x = ${Fraction.format(x, true)} $$`);
                    stepsHtml += createStep('4. Encontrar $y$', `$$... \\implies y = ${Fraction.format(y, true)} $$`);
                } else { // variable === 'x'
                    const x_const = Fraction.divide(c, a);
                    const x_y_coeff = Fraction.divide(Fraction.negate(b), a);
                    const x_expr_str = `${Fraction.format(x_const, true)} ${Fraction.formatForEquation(x_y_coeff, 'y')}`;
                    stepsHtml += createStep('1. Despejar $x$ en la 1ª ecuación', `$$... \\implies x = ${x_expr_str} $$`);
                    stepsHtml += createStep('2. Sustituir $x$ en la 2ª ecuación', `$$ ${Fraction.formatForEquation(d, '')}\\left( ${x_expr_str} \\right) ${Fraction.formatForEquation(e, 'y')} = ${Fraction.format(f, true)} $$`);
                    stepsHtml += createStep('3. Resolver para $y$', `$$... \\implies y = ${Fraction.format(y, true)} $$`);
                    stepsHtml += createStep('4. Encontrar $x$', `$$... \\implies x = ${Fraction.format(x, true)} $$`);
                }
                return stepsHtml;
            }

            function solveBySustitucion(coeffs, solution, caseType, initialVariable = 'y') {
                const availableChoices = [];
                if (!Fraction.isZero(coeffs.b)) availableChoices.push('y');
                if (!Fraction.isZero(coeffs.a)) availableChoices.push('x');
                
                let variable = initialVariable;
                if (!availableChoices.includes(variable)) {
                    variable = availableChoices.length > 0 ? availableChoices[0] : null;
                }
                
                const stepsHtml = getSustitucionStepsHtml({ ...coeffs, solution, caseType, variable });
                buildAlgebraicMethodUI('sustitucion', 'Método de Sustitución', stepsHtml, solution, caseType, { variable, available: availableChoices });
            }

            function getIgualacionStepsHtml({a, b, c, d, e, f, solution, caseType, variable}) {
                 if (caseType !== 'unica' || !variable) return '';
                 const {x, y} = solution;
                 let stepsHtml = '';
                 if (variable === 'x') {
                    const x1_expr = `${Fraction.format(Fraction.divide(c,a),true)} ${Fraction.formatForEquation(Fraction.divide(Fraction.negate(b),a), 'y')}`;
                    const x2_expr = `${Fraction.format(Fraction.divide(f,d),true)} ${Fraction.formatForEquation(Fraction.divide(Fraction.negate(e),d), 'y')}`;
                    stepsHtml += createStep('1. Despejar $x$ en ambas ecuaciones', `Ec. 1: $ x = ${x1_expr} $<br>Ec. 2: $ x = ${x2_expr} $`);
                    stepsHtml += createStep('2. Igualar las expresiones para $x$', `$$ ${x1_expr} = ${x2_expr} $$`);
                    stepsHtml += createStep('3. Resolver para $y$', `$$... \\implies y = ${Fraction.format(y, true)} $$`);
                    stepsHtml += createStep('4. Encontrar $x$ usando $y$', `$$... \\implies x = ${Fraction.format(x, true)} $$`);
                 } else { // variable === 'y'
                    const y1_expr = `${Fraction.format(Fraction.divide(c,b),true)} ${Fraction.formatForEquation(Fraction.divide(Fraction.negate(a),b), 'x')}`;
                    const y2_expr = `${Fraction.format(Fraction.divide(f,e),true)} ${Fraction.formatForEquation(Fraction.divide(Fraction.negate(d),e), 'x')}`;
                    stepsHtml += createStep('1. Despejar $y$ en ambas ecuaciones', `Ec. 1: $ y = ${y1_expr} $<br>Ec. 2: $ y = ${y2_expr} $`);
                    stepsHtml += createStep('2. Igualar las expresiones para $y$', `$$ ${y1_expr} = ${y2_expr} $$`);
                    stepsHtml += createStep('3. Resolver para $x$', `$$... \\implies x = ${Fraction.format(x, true)} $$`);
                    stepsHtml += createStep('4. Encontrar $y$ usando $x$', `$$... \\implies y = ${Fraction.format(y, true)} $$`);
                 }
                 return stepsHtml;
            }

            function solveByIgualacion(coeffs, solution, caseType, initialVariable = 'x') {
                const availableChoices = [];
                if (!Fraction.isZero(coeffs.a) && !Fraction.isZero(coeffs.d)) availableChoices.push('x');
                if (!Fraction.isZero(coeffs.b) && !Fraction.isZero(coeffs.e)) availableChoices.push('y');

                let variable = initialVariable;
                if (!availableChoices.includes(variable)) {
                    variable = availableChoices.length > 0 ? availableChoices[0] : null;
                }
                
                const stepsHtml = getIgualacionStepsHtml({ ...coeffs, solution, caseType, variable });
                buildAlgebraicMethodUI('igualacion', 'Método de Igualación', stepsHtml, solution, caseType, { variable, available: availableChoices });
            }

            function getReduccionStepsHtml({a, b, c, d, e, f, solution, caseType, variable}) {
                if (caseType !== 'unica') return '';
                const {x, y} = solution;
                let stepsHtml = '';
                if (variable === 'x') {
                    const m1 = d;
                    const m2 = Fraction.negate(a);
                    const eq1_mult = { a: Fraction.multiply(a, m1), b: Fraction.multiply(b, m1), c: Fraction.multiply(c, m1) };
                    const eq2_mult = { d: Fraction.multiply(d, m2), e: Fraction.multiply(e, m2), f: Fraction.multiply(f, m2) };
                    const final_y_coeff = Fraction.add(eq1_mult.b, eq2_mult.e);
                    const final_y_const = Fraction.add(eq1_mult.c, eq2_mult.f);
                    
                    stepsHtml += createStep('1. Preparar la multiplicación', `$$ \\begin{cases} ${Fraction.formatForEquation(a,'x',true)} ${Fraction.formatForEquation(b,'y')} = ${Fraction.format(c,true)} & \\xrightarrow{\\times (${Fraction.format(m1)})} \\\\ ${Fraction.formatForEquation(d,'x',true)} ${Fraction.formatForEquation(e,'y')} = ${Fraction.format(f,true)} & \\xrightarrow{\\times (${Fraction.format(m2)})} \\end{cases} $$`);
                    stepsHtml += createStep('2. Sistema resultante', `$$ \\begin{cases} ${Fraction.formatForEquation(eq1_mult.a,'x',true)} ${Fraction.formatForEquation(eq1_mult.b,'y')} = ${Fraction.format(eq1_mult.c)} \\\\ ${Fraction.formatForEquation(eq2_mult.d,'x',true)} ${Fraction.formatForEquation(eq2_mult.e,'y')} = ${Fraction.format(eq2_mult.f)} \\end{cases} $$`);
                    stepsHtml += createStep('3. Sumar y resolver para $y$', `$$ ${Fraction.formatForEquation(final_y_coeff, 'y', true)} = ${Fraction.format(final_y_const,true)} \\implies y = ${Fraction.format(y, true)} $$`);
                    stepsHtml += createStep('4. Encontrar $x$ por sustitución', `$$... \\implies x = ${Fraction.format(x, true)} $$`);
                } else { // variable === 'y'
                    const m1 = e;
                    const m2 = Fraction.negate(b);
                    const eq1_mult = { a: Fraction.multiply(a, m1), b: Fraction.multiply(b, m1), c: Fraction.multiply(c, m1) };
                    const eq2_mult = { d: Fraction.multiply(d, m2), e: Fraction.multiply(e, m2), f: Fraction.multiply(f, m2) };
                    const final_x_coeff = Fraction.add(eq1_mult.a, eq2_mult.d);
                    const final_x_const = Fraction.add(eq1_mult.c, eq2_mult.f);

                    stepsHtml += createStep('1. Preparar la multiplicación', `$$ \\begin{cases} ${Fraction.formatForEquation(a,'x',true)} ${Fraction.formatForEquation(b,'y')} = ${Fraction.format(c,true)} & \\xrightarrow{\\times (${Fraction.format(m1)})} \\\\ ${Fraction.formatForEquation(d,'x',true)} ${Fraction.formatForEquation(e,'y')} = ${Fraction.format(f,true)} & \\xrightarrow{\\times (${Fraction.format(m2)})} \\end{cases} $$`);
                    stepsHtml += createStep('2. Sistema resultante', `$$ \\begin{cases} ${Fraction.formatForEquation(eq1_mult.a,'x',true)} ${Fraction.formatForEquation(eq1_mult.b,'y')} = ${Fraction.format(eq1_mult.c)} \\\\ ${Fraction.formatForEquation(eq2_mult.d,'x',true)} ${Fraction.formatForEquation(eq2_mult.e,'y')} = ${Fraction.format(eq2_mult.f)} \\end{cases} $$`);
                    stepsHtml += createStep('3. Sumar y resolver para $x$', `$$ ${Fraction.formatForEquation(final_x_coeff, 'x', true)} = ${Fraction.format(final_x_const,true)} \\implies x = ${Fraction.format(x, true)} $$`);
                    stepsHtml += createStep('4. Encontrar $y$ por sustitución', `$$... \\implies y = ${Fraction.format(y, true)} $$`);
                }
                return stepsHtml;
            }

            function solveByReduccion(coeffs, solution, caseType, initialVariable = 'x') {
                const {a, b, d, e} = coeffs;
                if (caseType === 'unica' && (Fraction.isZero(a) || Fraction.isZero(b) || Fraction.isZero(d) || Fraction.isZero(e))) {
                     const container = document.getElementById('reduccion');
                    const finalSolutionHtml = `<div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-center">
                        <h4 class="text-base font-bold text-green-800">Solución Final</h4>
                        <p class="text-xl font-mono text-green-900 mt-1">$$ x = ${Fraction.format(solution.x, true)} \\quad , \\quad y = ${Fraction.format(solution.y, true)} $$</p>
                    </div>`;
                    
                    const explanationHtml = createStep(
                        'Nota sobre el Método de Reducción',
                        'Cuando el coeficiente de una variable es 0, esa variable ya está prácticamente despejada en una de las ecuaciones. <br><br> En estos casos, el método de reducción no es el más práctico. La solución se encuentra de forma mucho más directa por <b>sustitución</b> o <b>igualación</b>.'
                    );

                    container.innerHTML = `<h3 class="text-xl font-bold mb-4 text-center">Método de Reducción</h3>${finalSolutionHtml}${explanationHtml}`;
                    renderMathInElement(container);
                    return;
                }

                const availableChoices = ['x', 'y'];
                const stepsHtml = getReduccionStepsHtml({ ...coeffs, solution, caseType, variable: initialVariable });
                buildAlgebraicMethodUI('reduccion', 'Método de Reducción', stepsHtml, solution, caseType, { variable: initialVariable, available: availableChoices });
            }


            // --- GRAPHICAL METHOD IMPLEMENTATION ---
            
            let handleZoom; // Declare here to be accessible in chart options

            function solveByGrafico({a, b, c, d, e, f}, solution, caseType) {
                graphContainer.classList.remove('hidden');
                graphPlaceholder.classList.add('hidden');
                zoomControls.classList.remove('hidden');
                
                let eq1Text, eq2Text;
                // Equation 1
                if (!Fraction.isZero(b)) {
                    const m1 = Fraction.divide(Fraction.negate(a), b);
                    const n1 = Fraction.divide(c, b);
                    eq1Text = `Recta 1 (azul): $y = ${Fraction.formatForEquation(m1, 'x', true)} ${Fraction.formatForEquation(n1, '', Fraction.isZero(m1))}$`;
                } else if (!Fraction.isZero(a)) {
                    eq1Text = `Recta 1 (azul): $x = ${Fraction.format(Fraction.divide(c,a), true)}$ (Recta Vertical)`;
                } else {
                    eq1Text = 'Recta 1 (azul): Ecuación inválida (0=c)';
                }
                // Equation 2
                if (!Fraction.isZero(e)) {
                    const m2 = Fraction.divide(Fraction.negate(d), e);
                    const n2 = Fraction.divide(f, e);
                    eq2Text = `Recta 2 (roja): $y = ${Fraction.formatForEquation(m2, 'x', true)} ${Fraction.formatForEquation(n2, '', Fraction.isZero(m2))}$`;
                } else if (!Fraction.isZero(d)) {
                    eq2Text = `Recta 2 (roja): $x = ${Fraction.format(Fraction.divide(f,d), true)}$ (Recta Vertical)`;
                } else {
                    eq2Text = 'Recta 2 (roja): Ecuación inválida (0=f)';
                }

                const graphInfoDiv = document.getElementById('graph-info');
                graphInfoDiv.innerHTML = createStep('Ecuaciones en forma explícita ($y=mx+n$)', `${eq1Text}<br>${eq2Text}`);
                renderMathInElement(graphInfoDiv);

                if (chartInstance) chartInstance.destroy();

                const generateLineData = (m, n, range) => [{x: range.min, y: m * range.min + n}, {x: range.max, y: m * range.max + n}];
                const generateVerticalLineData = (k, range) => [{x: k, y: range.min}, {x: k, y: range.max}];
                
                let minX, maxX, minY, maxY;
                const PADDING = 10;
                if (caseType === 'unica' && solution) {
                    const solX = Fraction.toDecimal(solution.x);
                    const solY = Fraction.toDecimal(solution.y);
                    minX = solX - PADDING; maxX = solX + PADDING;
                    minY = solY - PADDING; maxY = solY + PADDING;
                } else {
                    minX = -PADDING; maxX = PADDING;
                    minY = -PADDING; maxY = PADDING;
                }
                
                const initialXRange = { min: minX, max: maxX };
                const initialYRange = { min: minY, max: maxY };

                let line1Data = [];
                if (!Fraction.isZero(b)) {
                    line1Data = generateLineData(Fraction.toDecimal(Fraction.divide(Fraction.negate(a), b)), Fraction.toDecimal(Fraction.divide(c,b)), initialXRange);
                } else if (!Fraction.isZero(a)) {
                    line1Data = generateVerticalLineData(Fraction.toDecimal(Fraction.divide(c,a)), initialYRange);
                }

                let line2Data = [];
                if (!Fraction.isZero(e)) {
                    line2Data = generateLineData(Fraction.toDecimal(Fraction.divide(Fraction.negate(d), e)), Fraction.toDecimal(Fraction.divide(f,e)), initialXRange);
                } else if (!Fraction.isZero(d)) {
                    line2Data = generateVerticalLineData(Fraction.toDecimal(Fraction.divide(f,d)), initialYRange);
                }

                const datasets = [
                    { label: `Recta 1`, borderColor: '#3b82f6', borderWidth: 2.5, fill: false, pointRadius: 0, type: 'line', data: line1Data },
                    { label: `Recta 2`, borderColor: '#ef4444', borderWidth: 2.5, fill: false, pointRadius: 0, type: 'line', data: line2Data }
                ];
                
                let chartTitle = 'Gráfico del Sistema';
                if (caseType === 'unica' && showSolutionCheckbox.checked) {
                    const solX_dec = Fraction.toDecimal(solution.x).toFixed(2);
                    const solY_dec = Fraction.toDecimal(solution.y).toFixed(2);
                    const solX_frac = Fraction.format(solution.x);
                    const solY_frac = Fraction.format(solution.y);

                    datasets.push({ label: `Solución`, data: [{x: Fraction.toDecimal(solution.x), y: Fraction.toDecimal(solution.y)}], backgroundColor: '#f59e0b', pointRadius: 8, pointHoverRadius: 10, type: 'scatter' });
                    chartTitle = `Punto de corte: (x=${solX_frac} ≈ ${solX_dec}, y=${solY_frac} ≈ ${solY_dec})`;
                } else if (caseType === 'infinitas') {
                    chartTitle = "Infinitas Soluciones: Las rectas son coincidentes.";
                    datasets[1].borderColor = '#60a5fa'; datasets[1].borderDash = [5, 5];
                } else if (caseType === 'paralelas') {
                    chartTitle = "Sin Solución: Las rectas son paralelas.";
                }

                handleZoom = (chart) => {
                    if (!chart || !chart.scales || !chart.scales.x) return;
                    
                    const xRange = { min: chart.scales.x.min, max: chart.scales.x.max };
                    const yRange = { min: chart.scales.y.min, max: chart.scales.y.max };
                    
                    if (!Fraction.isZero(b)) {
                        chart.data.datasets[0].data = generateLineData(Fraction.toDecimal(Fraction.divide(Fraction.negate(a), b)), Fraction.toDecimal(Fraction.divide(c, b)), xRange);
                    } else if (!Fraction.isZero(a)) {
                        chart.data.datasets[0].data = generateVerticalLineData(Fraction.toDecimal(Fraction.divide(c, a)), yRange);
                    }

                    if (!Fraction.isZero(e)) {
                        chart.data.datasets[1].data = generateLineData(Fraction.toDecimal(Fraction.divide(Fraction.negate(d), e)), Fraction.toDecimal(Fraction.divide(f, e)), xRange);
                    } else if (!Fraction.isZero(d)) {
                        chart.data.datasets[1].data = generateVerticalLineData(Fraction.toDecimal(Fraction.divide(f, d)), yRange);
                    }
                    chart.update('none');
                };

                chartInstance = new Chart(document.getElementById('chart').getContext('2d'), {
                    data: { datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { type: 'linear', position: 'bottom', min: minX, max: maxX, title: { display: true, text: 'Eje X' }, grid: { color: (c) => c.tick.value === 0 ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.1)', lineWidth: (c) => c.tick.value === 0 ? 2 : 1 }},
                            y: { min: minY, max: maxY, title: { display: true, text: 'Eje Y' }, grid: { color: (c) => c.tick.value === 0 ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.1)', lineWidth: (c) => c.tick.value === 0 ? 2 : 1 }}
                        },
                        plugins: {
                            title: { display: true, text: chartTitle, font: { size: 16 } },
                            legend: { position: 'top', labels: { font: { size: 12 } } },
                            zoom: {
                                pan: { 
                                    enabled: true, 
                                    mode: 'xy',
                                    onPanComplete: ({chart}) => handleZoom(chart)
                                },
                                zoom: { 
                                    wheel: { enabled: true }, 
                                    pinch: { enabled: true }, 
                                    mode: 'xy',
                                    onZoomComplete: ({chart}) => handleZoom(chart)
                                }
                            }
                        }
                    }
                });
            }

            // --- Initial call to render math for any pre-loaded content ---
            renderMathInElement(document.body);
        });
    </script>
</body>
</html>
